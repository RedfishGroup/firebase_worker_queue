<html>
<title>Pi worker queue</title>
<head>
    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase.js"></script>
 

    <script type='module'>
        import * as Q from '../src/queue.js'

        /**
         * Throw a dart at a board. If it is in a circle return true
         *   The area of the circle in a 1x1 box is π/4. So the change of randomly landing in the circle is also π/4.
         *      
         *   
         * */
        function sample() {
            const x = Math.random()-0.5
            const y = Math.random()-0.5
            const dist = Math.hypot(x,y)
            return dist <= 0.5
        }

        function sampleNTimes(n){
            let sum = 0
            for(let i=0; i<n;i++){
                sum =  sum + sample()*1
            }
            return {sum, n, ratio:sum/n}
        }   

        const timeoutDelay = (ms) => new Promise((res) => setTimeout(res, ms))

        /**
         * This flavor of the function manages to not block the main thread. 
         * 
         * */
        async function sampleNTimesAsync(n=100000, sampletSize=1000000){
            let count = n
            let sum = 0
            while(count > 0){
                const s = Math.min(sampletSize, count)
                const res = sampleNTimes(s)
                sum += res.sum
                await timeoutDelay(0)
                count=count-s
            }
            return {sum, n, ratio:sum/n}

        } 

        /**
         * Worker Queue portion
         * 
         * */
         var app = firebase.initializeApp({
            apiKey: 'AIzaSyCKuD19DkUeHtEawjVB5IPCXSqe5lkaWIY',
            databaseURL: 'https://workerqueuedemo.firebaseio.com/',
            projectId: 'workerqueuedemo',
        })
        const db = app.database()
        const ref = db.ref().child('demo').child('pi')

        var stateForUI = 'idle' 
        let sum = 0
        let count = 0
        updateUI()

        Q.watchQueueAsync(ref,async (task)=>{
            try{
                stateForUI = 'claiming task'
                updateUI()
                const ticket = await Q.claimTask(ref,task,'pi client')
                console.time('computation')
                stateForUI = 'computing'
                updateUI()
                const result = await sampleNTimesAsync(ticket.n)
                console.timeEnd('computing...')
                await Q.completeTask(ref, ticket, result)
                stateForUI = 'idle'
                updateUI()
            } catch(err) {
                console.log('did not claim task:', err)
            }
        })

        window.addTask = async function addTask(){
            await Q.addTask(ref, {
                n:100000000,
                signed:'pi demo'
            })
        }

        /**
         * Keep a running total
         * */

        ref.child('complete').on('child_added',async (snap)=>{
            // there should be a helper for this
            const snap2 = await ref.child('tasks').child(snap.key).once('value')
            const val = snap2.val()
            if (val.result){
                sum = sum + val.result.sum
                count = count + val.result.n
            }
            console.log('pi ~=', 4*(sum/count))
            updateUI()
        })


       function updateUI(){
        document.getElementById('status').innerText = `status: ${stateForUI}`
        document.getElementById('results').innerHTML = `<div>total samples:${count}</div>
        <div>total samples in circle:${sum}</div>
        <div>pi estimation:${4*(sum/count)}</div>
        <div>pi estimation error:${Math.abs(Math.PI - 4*(sum/count))}</div>`

       }





    </script>
</head>
<body>
    <button onclick="addTask()">Add Task To Queue</button>
    <div id='status'></div>
    <div id='results'></div>
</body>
</html>